<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç®¡ç†å‘˜ç«¯ Â· åœ¨çº¿æ•™è‚²</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <style>
    :root { --ink:#0f172a; --muted:#6b7280; --accent:#0ea5e9; --bg:linear-gradient(135deg,#eef2ff 0%,#f8fafc 100%); }
    * { font-family:'Space Grotesk','Helvetica Neue',sans-serif; }
    body { background: var(--bg); color: var(--ink); }
    .app { max-width: 1200px; margin: 0 auto; padding: 28px 16px 52px; }
    .card { border:0; box-shadow:0 10px 28px rgba(0,0,0,0.08); }
    .scroll-box { max-height: 260px; overflow: auto; }
    .bar-row { display:flex; align-items:center; gap:8px; font-family:monospace; font-size:13px; }
    .bar { height:8px; background: var(--accent); border-radius: 4px; min-width:8px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="mb-0">ç®¡ç†å‘˜ / å¹´çº§ä¸»ä»»</h2>
        <div class="text-muted small">ç»Ÿè®¡åˆ†æ Â· æŠ¥è¡¨ Â· æˆç»©ç»´æŠ¤ Â· æ•™å¸ˆåˆ—è¡¨</div>
        <div class="text-warning small">è¯´æ˜ï¼šä»… ADMIN è§’è‰²ï¼›è¯¾ç¨‹å®¡æ ¸å·²æ¥é€šåç«¯æ¥å£ï¼›ç”¨æˆ·è´¦å·ç®¡ç†å·²å¼€æ”¾ã€‚</div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <div id="user-info" class="small text-muted">æ£€æµ‹ç™»å½•ä¸­â€¦</div>
        <a class="btn btn-outline-primary btn-sm" href="user-admin.html">ç”¨æˆ·ç®¡ç†</a>
        <a class="btn btn-outline-success btn-sm" href="analytics.html">å¯è§†åŒ–</a>
        <button class="btn btn-outline-secondary btn-sm" onclick="logout()">é€€å‡º</button>
        <a class="btn btn-outline-primary btn-sm" href="index.html">è¿”å›é¦–é¡µ</a>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="fw-semibold mb-2">ç»Ÿè®¡</div>
            <div class="row g-2 mb-2">
              <div class="col-6"><input id="stat-grade" type="number" class="form-control" placeholder="å¹´çº§ID" /></div>
              <div class="col-6"><input id="stat-class" type="number" class="form-control" placeholder="ç­çº§ID" /></div>
            </div>
            <div class="d-flex flex-wrap gap-2 mb-2">
              <button class="btn btn-outline-primary btn-sm" onclick="loadStatsUsers()">ç”¨æˆ·æ•°</button>
              <button class="btn btn-outline-primary btn-sm" onclick="loadGradeDistribution()">å¹´çº§åˆ†å¸ƒ</button>
              <button class="btn btn-outline-secondary btn-sm" onclick="loadGradeLines()">å¹´çº§æ›²çº¿</button>
              <button class="btn btn-outline-secondary btn-sm" onclick="loadGradeScoreSeries()">å¹´çº§ç§‘ç›®æŸ±çŠ¶</button>
              <button class="btn btn-outline-secondary btn-sm" onclick="loadClassLines()">ç­çº§æ›²çº¿</button>
              <button class="btn btn-outline-secondary btn-sm" onclick="loadClassScoreSeries()">ç­çº§ç§‘ç›®æŸ±çŠ¶</button>
            </div>
            <pre id="stats-box" class="small scroll-box">ç­‰å¾…è¯·æ±‚â€¦</pre>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="fw-semibold mb-2">æŠ¥è¡¨ Â· æˆç»©å•</div>
            <div class="row g-2 mb-2">
              <div class="col-6 d-flex gap-2">
                <select id="report-grade" class="form-select"></select>
                <button class="btn btn-outline-primary" onclick="loadReportClasses()">å–ç­çº§</button>
              </div>
              <div class="col-6 d-flex gap-2">
                <select id="report-class" class="form-select"></select>
                <button class="btn btn-outline-primary" onclick="loadStudentGrades()">å­¦ç”Ÿæˆç»©</button>
              </div>
            </div>
            <button class="btn btn-outline-primary btn-sm mb-2" onclick="loadGradeLevels()">åŠ è½½å¹´çº§åˆ—è¡¨</button>
            <pre id="reports-box" class="small scroll-box">ç­‰å¾…åŠ è½½â€¦</pre>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-semibold">ç­çº§ç®¡ç†</div>
              <button class="btn btn-outline-primary btn-sm" onclick="loadManageClasses()">åˆ·æ–°</button>
            </div>
            <div class="d-flex gap-2 mb-2">
              <select id="manage-grade" class="form-select" style="max-width:220px;"></select>
              <button class="btn btn-outline-primary btn-sm" onclick="loadManageClasses()">æŸ¥çœ‹ç­çº§</button>
            </div>
            <div id="manage-class-box" class="small text-muted scroll-box" style="min-height:140px;">æœªåŠ è½½</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="fw-semibold mb-2">æˆç»©ç»´æŠ¤</div>
            <div class="row g-2 mb-2">
              <div class="col-6"><input id="grade-id" class="form-control" placeholder="æˆç»©ID(æ›´æ–°å¡«)" /></div>
              <div class="col-6"><input id="grade-score" type="number" step="0.01" class="form-control" placeholder="åˆ†æ•°" /></div>
              <div class="col-6"><input id="grade-student" type="number" class="form-control" placeholder="å­¦ç”ŸID" /></div>
              <div class="col-6"><input id="grade-course" type="number" class="form-control" placeholder="è¯¾ç¨‹ID" /></div>
              <div class="col-6"><input id="grade-class" type="number" class="form-control" placeholder="ç­çº§ID" /></div>
              <div class="col-6"><input id="grade-type" class="form-control" placeholder="ç±»å‹(å¯é€‰)" /></div>
            </div>
            <textarea id="grade-remarks" class="form-control mb-2" rows="2" placeholder="å¤‡æ³¨"></textarea>
            <button class="btn btn-primary w-100" onclick="saveGrade()">ä¿å­˜/æ›´æ–°</button>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="fw-semibold mb-2">æ•™å¸ˆåˆ—è¡¨</div>
            <button class="btn btn-outline-primary btn-sm mb-2" onclick="loadTeachers()">åˆ·æ–°</button>
            <div id="admin-teacher-box" class="small text-muted scroll-box">æœªåŠ è½½</div>
            <div class="text-muted small mt-3">è¯¾ç¨‹å®¡æ ¸ï¼šä¸‹æ–¹è¯¾ç¨‹å¡ç‰‡å¯å®¡æ ¸ã€‚</div>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-semibold">æ•™å¸ˆåœ¨çº¿è¯¾</div>
              <button class="btn btn-outline-primary btn-sm" onclick="loadTeachers()">åˆ·æ–°</button>
            </div>
            <div id="teacher-links" class="row g-2 small text-muted">æœªåŠ è½½</div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-semibold">ä½œä¸šä»»åŠ¡</div>
              <button class="btn btn-outline-primary btn-sm" onclick="loadAssignments()">åˆ·æ–°</button>
            </div>
            <div class="small text-muted mb-2">ç‚¹å‡»ä½œä¸šæŸ¥çœ‹è¯¦æƒ…</div>
            <div id="assignment-list" class="small" style="min-height:160px;">æœªåŠ è½½</div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-semibold">ä½œä¸šä¿¡æ¯</div>
              <button class="btn btn-outline-primary btn-sm" onclick="reloadSelectedAssignment()">åˆ·æ–°å½“å‰</button>
            </div>
            <pre id="assignment-info-box" class="small text-muted mb-0" style="min-height:160px;">è¯·åœ¨å·¦ä¾§ç‚¹å‡»ä½œä¸šæŸ¥çœ‹è¯¦æƒ…</pre>
          </div>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="fw-semibold">è§†é¢‘å®¡æ ¸</div>
            <div class="text-muted small">çœŸå®å¾…å®¡æ ¸åˆ—è¡¨ï¼Œå¯é€šè¿‡/ä¸é€šè¿‡å¹¶å¡«å†™å¤‡æ³¨</div>
          </div>
          <button class="btn btn-sm btn-outline-primary" onclick="loadPendingVideos()">åˆ·æ–°å¾…å®¡æ ¸</button>
        </div>
        <div id="video-review-list" class="row g-3"><div class="col-12 text-muted">ç‚¹å‡»â€œåˆ·æ–°å¾…å®¡æ ¸â€åŠ è½½</div></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
  <script>
    axios.defaults.withCredentials=true;
    let API='http://39.106.139.93:8081/api/v2';
    let currentUser=null;

    function setApiFromQuery(){ const p=new URLSearchParams(location.search); const api=p.get('api'); if(api) API=api.replace(/\/$/,''); }
    function ensureAdmin(role){ if(role!=='ADMIN'){ document.getElementById('user-info').textContent='å½“å‰è§’è‰²æ— æƒé™ï¼Œè¯·ç”¨ç®¡ç†å‘˜ç™»å½•'; return false; } return true; }

    let initialized=false;
    let selectedAssignmentId=null;
    async function loadMe(){
      try{
        const {data}=await axios.get(`${API}/auth/me`);
        if(!data.loggedIn){ document.getElementById('user-info').textContent='æœªç™»å½•ï¼Œè¯·å…ˆè¿”å›é¦–é¡µç™»å½•'; return; }
        currentUser=data;
        if(!ensureAdmin(data.role)) return;
        document.getElementById('user-info').textContent=`${data.username} (${data.role})`;
        if(!initialized){ initialized=true; initAdminData(); }
      }catch(_){ document.getElementById('user-info').textContent='ä¼šè¯æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–é‡æ–°ç™»å½•'; }
    }

    function initAdminData(){
      loadStatsUsers();
      loadGradeLevels();
      loadManageGradeLevels();
      loadTeachers();
      loadCourses();
      loadAssignments();
    }

    async function loadManageGradeLevels(){
      const sel=document.getElementById('manage-grade');
      const box=document.getElementById('manage-class-box');
      sel.innerHTML='<option>åŠ è½½ä¸­â€¦</option>';
      try{
        const data=await safeGet('/reports/grade-levels');
        if(!data||!data.length){ sel.innerHTML='<option value="">æ— å¹´çº§</option>'; box.textContent='æš‚æ— ç­çº§'; return; }
        sel.innerHTML=data.map(g=>`<option value="${g.id}">${g.name||('å¹´çº§'+g.id)}</option>`).join('');
        sel.value=data[0].id;
        await loadManageClasses();
      }catch(e){ sel.innerHTML='<option value="">åŠ è½½å¤±è´¥</option>'; if(box) box.textContent='å¹´çº§åŠ è½½å¤±è´¥'; }
    }

    async function loadManageClasses(){
      const gid=document.getElementById('manage-grade')?.value;
      const box=document.getElementById('manage-class-box');
      if(!gid){ box.textContent='è¯·é€‰æ‹©å¹´çº§'; return; }
      box.textContent='åŠ è½½ä¸­â€¦';
      try{
        const data=await safeGet(`/reports/grade-levels/${gid}/classes`);
        if(!data||!data.length){ box.textContent='è¯¥å¹´çº§æš‚æ— ç­çº§'; return; }
        box.textContent=data.map(c=>`ç­çº§:${c.name||'-'} (#${c.id??'-'})`).join('\n');
      }catch(e){ box.textContent=`åŠ è½½å¤±è´¥ï¼š${e?.response?.data||e?.message||'é”™è¯¯'}`; }
    }

    async function safeGet(path){ const {data}=await axios.get(`${API}${path}`); return data; }
    function showError(boxId,msg){ const box=document.getElementById(boxId); if(box) box.innerHTML=`<div class="col-12 text-danger">${msg}</div>`; }

    function formatSize(s){ if(!s) return '-'; const n=Number(s); if(n>1e9) return (n/1e9).toFixed(2)+' GB'; if(n>1e6) return (n/1e6).toFixed(2)+' MB'; if(n>1e3) return (n/1e3).toFixed(1)+' KB'; return n+' B'; }

    function barRows(items){
      const max=Math.max(...items.map(i=>i.val||0),1);
      return items.map(i=>`<div class="bar-row"><div class="bar" style="width:${(i.val||0)/max*120}px"></div><span>${i.name}: ${i.val??'--'}</span></div>`).join('');
    }

    function renderStats(title,data){
      const box=document.getElementById('stats-box');
      if(!data || (Array.isArray(data)&&!data.length)) { box.textContent=`${title}: æš‚æ— æ•°æ®`; return; }
      if(Array.isArray(data)){
        const items=data.map(item=>({
          name:item.name||item.label||item.className||item.gradeName||item.subject||'é¡¹',
          val:item.value??item.total??item.count??item.score??item.average
        }));
        box.innerHTML=`${title}:`+barRows(items);
        return;
      }
      const parts=[];
      if(data.totalUsers) parts.push({name:'æ€»ç”¨æˆ·', val:data.totalUsers});
      if(data.totalStudents) parts.push({name:'å­¦ç”Ÿ', val:data.totalStudents});
      if(data.totalTeachers) parts.push({name:'æ•™å¸ˆ', val:data.totalTeachers});
      if(data.totalAdmins) parts.push({name:'ç®¡ç†å‘˜', val:data.totalAdmins});
      if(!parts.length) { box.textContent=`${title}:\n`+JSON.stringify(data,null,2); return; }
      box.innerHTML=`${title}:`+barRows(parts);
    }

    async function loadStatsUsers(){ const data=await safeGet('/stats/users'); renderStats('ç”¨æˆ·æ•°', data); }
    async function loadGradeDistribution(){ const data=await safeGet('/stats/grade-distribution'); renderStats('å¹´çº§åˆ†å¸ƒ', data); }
    async function loadGradeLines(){ const gid=document.getElementById('stat-grade').value; if(!gid) return alert('å¡«å…¥å¹´çº§ID'); const data=await safeGet(`/stats/grade-line?gradeLevelId=${gid}`); renderStats('å¹´çº§æ›²çº¿', data.series||data); }
    async function loadClassLines(){ const cid=document.getElementById('stat-class').value; if(!cid) return alert('å¡«å…¥ç­çº§ID'); const data=await safeGet(`/stats/class-line?classId=${cid}`); renderStats('ç­çº§æ›²çº¿', data.series||data); }
    async function loadGradeScoreSeries(){ const data=await safeGet('/stats/grade-score-series'); renderStats('å¹´çº§ç§‘ç›®æŸ±çŠ¶', data.series||data); }
    async function loadClassScoreSeries(){ const gid=document.getElementById('stat-grade').value; const path=gid?`/stats/class-score-series?gradeLevelId=${gid}`:'/stats/class-score-series'; const data=await safeGet(path); renderStats('ç­çº§ç§‘ç›®æŸ±çŠ¶', data.series||data); }

    function renderReports(title,data){
      const box=document.getElementById('reports-box');
      if(!data || (Array.isArray(data)&&!data.length)){ box.textContent=`${title}: æš‚æ— æ•°æ®`; return; }
      if(Array.isArray(data)){
        const items=data.map(item=>({
          name:item.name||item.className||item.studentName||item.subject||'é¡¹',
          val:item.score??item.average??item.total??item.value
        }));
        box.innerHTML=`${title}:`+barRows(items);
      } else {
        box.textContent=`${title}:\n`+JSON.stringify(data,null,2);
      }
    }

    function renderStudentGrades(data){
      const box=document.getElementById('reports-box');
      if(!data||!data.length){ box.textContent='å­¦ç”Ÿæˆç»©: æš‚æ— æ•°æ®'; return; }
      const lines=data.map(s=>{
        const header=`å­¦ç”Ÿ:${s.name||'-'} (${s.studentNo||'-'}) | ç­çº§:${s.className||'-'} | å¹´çº§:${s.gradeLevel||'-'}`;
        if(!s.grades||!s.grades.length) return `<div>${header} | æˆç»©: æ— </div>`;
        const max=Math.max(...s.grades.map(g=>g.score||g.grade||0),1);
        const gs=s.grades.map(g=>{
          const score=g.score??g.grade??0;
          const status=typeof score==='number'?(score>=60?'åŠæ ¼':'ä¸åŠæ ¼'):'æœªçŸ¥';
          return `<div class="bar-row"><div class="bar" style="width:${score/max*120}px"></div><span>è¯¾ç¨‹:${g.courseId??'-'} åˆ†æ•°:${score} çŠ¶æ€:${status}${g.type?` ç±»å‹:${g.type}`:''}</span></div>`;
        }).join('');
        return `<div class="mb-2"><div class="fw-semibold" style="font-size:13px;">${header}</div>${gs}</div>`;
      });
      box.innerHTML='å­¦ç”Ÿæˆç»©:'+lines.join('');
    }

    async function loadGradeLevels(){ const data=await safeGet('/reports/grade-levels'); const sel=document.getElementById('report-grade'); sel.innerHTML=data.map(gl=>`<option value="${gl.id}">${gl.name}</option>`).join(''); if(data[0]){ sel.value=data[0].id; await loadReportClasses(); } renderReports('å¹´çº§åˆ—è¡¨', data); }
    async function loadReportClasses(){ const gid=document.getElementById('report-grade').value; if(!gid) return; const data=await safeGet(`/reports/grade-levels/${gid}/classes`); const sel=document.getElementById('report-class'); sel.innerHTML=data.map(c=>`<option value="${c.id}">${c.name}</option>`).join(''); if(data[0]) sel.value=data[0].id; renderReports('ç­çº§åˆ—è¡¨', data); }
    async function loadStudentGrades(){ const cid=document.getElementById('report-class').value; if(!cid) return alert('é€‰æ‹©ç­çº§'); const data=await safeGet(`/reports/classes/${cid}/student-grades`); renderStudentGrades(data); }

    function renderAssignmentInfo(data){
      const box=document.getElementById('assignment-info-box');
      if(!box) return;
      if(!data){ box.textContent='æœªåŠ è½½'; return; }
      const a=data.assignment||{};
      const subs=data.submissions||[];
      const due=a.dueDate||'-';
      const header=`ä½œä¸š:${a.title||'-'}\næè¿°:${a.description||''}\nè¯¾ç¨‹:${a.courseId??'-'} æˆªæ­¢:${due} åˆ›å»º:${a.createdBy??'-'}`;
      if(!subs.length){ box.textContent=header+"\næäº¤: æš‚æ— "; return; }
      const lines=subs.map(s=>{
        const score=s.grade??'-';
        const status=s.status||'SUBMITTED';
        return `æäº¤:${s.id??'-'} | å­¦ç”Ÿ:${s.studentId??'-'} | çŠ¶æ€:${status} | åˆ†æ•°:${score} | è¯„è¯­:${s.remarks||''}`;
      }).join('\n');
      box.textContent=`${header}\næäº¤(${subs.length}):\n${lines}`;
    }

    async function loadAssignmentInfo(id){
      if(!id) return;
      selectedAssignmentId=id;
      const box=document.getElementById('assignment-info-box');
      if(box) box.textContent='åŠ è½½ä¸­â€¦';
      try{
        const data=await safeGet(`/assignments/${id}/info`);
        renderAssignmentInfo(data);
      }catch(e){ if(box) box.textContent=`åŠ è½½å¤±è´¥ï¼š${e?.response?.data||e?.message||'é”™è¯¯'}`; }
    }

    function reloadSelectedAssignment(){ if(selectedAssignmentId) loadAssignmentInfo(selectedAssignmentId); }

    async function saveGrade(){ const id=document.getElementById('grade-id').value; const payload={ studentId:parseInt(document.getElementById('grade-student').value)||null, courseId:parseInt(document.getElementById('grade-course').value)||null, score:parseFloat(document.getElementById('grade-score').value)||null, modifiedBy: currentUser?.id || null, classId:parseInt(document.getElementById('grade-class').value)||null, type:document.getElementById('grade-type').value||null, remarks:document.getElementById('grade-remarks').value||null }; try{ let data; if(id){ ({data}=await axios.put(`${API}/grades/${id}`, payload)); }else{ ({data}=await axios.post(`${API}/grades`, payload)); } alert('å·²ä¿å­˜'); document.getElementById('stats-box').textContent=JSON.stringify(data,null,2); }catch(e){ alert('ä¿å­˜å¤±è´¥'); } }

    function renderAssignments(data){
      const box=document.getElementById('assignment-list');
      if(!box) return;
      if(!data||!data.length){ box.textContent='æš‚æ— ä½œä¸š'; return; }
      box.innerHTML='';
      data.forEach(a=>{
        const due=a.dueDate||'-';
        const item=document.createElement('div');
        item.className='mb-1';
        item.innerHTML=`<a href="#" class="text-decoration-none" onclick="loadAssignmentInfo(${a.id}); return false;">${a.title||'æœªå‘½åä½œä¸š'}</a> Â· æˆªæ­¢:${due}`;
        box.appendChild(item);
      });
      if(!selectedAssignmentId && data[0]?.id) loadAssignmentInfo(data[0].id);
    }

    async function loadAssignments(){
      const box=document.getElementById('assignment-list');
      if(box) box.textContent='åŠ è½½ä¸­â€¦';
      try{
        const data=await safeGet('/assignments');
        renderAssignments(data);
      }catch(e){ if(box) box.textContent=`åŠ è½½å¤±è´¥ï¼š${e?.response?.data||e?.message||'é”™è¯¯'}`; }
    }

    function renderTeacherLinks(data){
      const box=document.getElementById('teacher-links');
      if(!box) return;
      if(!data||!data.length){ box.innerHTML='<div class="col-12 text-muted">æš‚æ— æ•™å¸ˆ</div>'; return; }
      box.innerHTML='';
      data.forEach(t=>{
        const col=document.createElement('div');
        col.className='col-12 col-md-6';
        const tid=t.id??'';
        // Card is the link to the teacher's video page
        col.innerHTML=`<a class="border rounded p-2 h-100 d-block text-decoration-none text-reset" href="videos.html?teacherId=${tid}">`
          +`<div class="fw-semibold">${t.username||'æ•™å¸ˆ'} <span class="text-muted">#${tid}</span></div>`
          +`<div class="text-muted">è§’è‰²: ${t.role||'TEACHER'}</div>`
          +`<div class="text-muted">ç‚¹å‡»æ‰“å¼€è¯¥æ•™å¸ˆçš„è§†é¢‘åˆ—è¡¨</div>`
          +`</a>`;
        box.appendChild(col);
      });
    }

    async function loadTeachers(){
      const box=document.getElementById('admin-teacher-box');
      try{
        const data=await safeGet('/users/teachers');
        if(!data||!data.length){ box.textContent='æš‚æ— æ•™å¸ˆ'; renderTeacherLinks(data); return; }
        box.textContent=data.map(t=>`æ•™å¸ˆ:${t.username||'-'} (#${t.id??'-'})`).join('\n');
        renderTeacherLinks(data);
      }catch(e){
        box.innerHTML=`<span class="text-danger">åŠ è½½æ•™å¸ˆå¤±è´¥ï¼š${e?.response?.status===403?'æ— æƒé™/æœªç™»å½•':(e?.response?.data||'é”™è¯¯')}</span>`;
        renderTeacherLinks([]);
      }
    }

    function renderCourseCards(data){ const box=document.getElementById('course-list'); box.innerHTML=''; if(!data.length){ box.innerHTML='<div class="col-12 text-muted">æš‚æ— è¯¾ç¨‹</div>'; return; } data.forEach(c=>{ const col=document.createElement('div'); col.className='col-12 col-md-6'; const approved=c.approved===true; col.innerHTML=`<div class="card h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-2"><h5 class="card-title mb-0">${c.title||'æœªå‘½å'}</h5><span class="badge ${approved?'bg-success':'bg-warning text-dark'}">${approved?'å·²å®¡æ ¸':'å¾…å®¡æ ¸'}</span></div><p class="text-muted small mb-2">${c.description||'æš‚æ— æè¿°'}</p><div class="d-flex gap-2 flex-wrap mb-2"><span class="badge bg-light text-dark">#${c.id}</span><span class="badge bg-light text-dark">æ•™å¸ˆ:${c.teacherId??'æœªæŒ‡å®š'}</span></div><div class="d-flex gap-2 flex-wrap"><a class="btn btn-sm btn-outline-primary" href="teacher.html?teacherId=${c.teacherId||''}">æ•™å¸ˆé¡µ</a><a class="btn btn-sm btn-outline-secondary" href="videos.html?teacherId=${c.teacherId||''}">ğŸ“¹ è¯¾ç¨‹è§†é¢‘</a><button class="btn btn-sm ${approved?'btn-outline-secondary':'btn-success'}" onclick="approveCourse(${c.id}, ${!approved})">${approved?'å–æ¶ˆå®¡æ ¸':'å®¡æ ¸é€šè¿‡'}</button></div></div></div>`; box.appendChild(col); }); }
    async function loadCourses(){ const box=document.getElementById('course-list'); box.innerHTML='<div class="col-12 text-muted">åŠ è½½ä¸­â€¦</div>'; try{ const data=await safeGet('/admin/courses'); renderCourseCards(data); }catch(e){ box.innerHTML=`<div class="col-12 text-danger">åŠ è½½è¯¾ç¨‹å¤±è´¥ï¼š${e?.response?.status===403?'æ— æƒé™/è¯·å…ˆç®¡ç†å‘˜ç™»å½•':(e?.response?.data||'é”™è¯¯')}</div>`; } }
    async function loadPending(){ const box=document.getElementById('course-list'); box.innerHTML='<div class="col-12 text-muted">åŠ è½½ä¸­â€¦</div>'; try{ const data=await safeGet('/admin/courses?pending=true'); renderCourseCards(data); }catch(e){ box.innerHTML=`<div class="col-12 text-danger">åŠ è½½è¯¾ç¨‹å¤±è´¥ï¼š${e?.response?.status===403?'æ— æƒé™/è¯·å…ˆç®¡ç†å‘˜ç™»å½•':(e?.response?.data||'é”™è¯¯')}</div>`; } }
    async function approveCourse(id, approved){ await axios.put(`${API}/admin/courses/${id}/approve?approved=${approved}`); loadCourses(); }

    async function loadPendingVideos(){
      const box=document.getElementById('video-review-list');
      box.innerHTML='<div class="col-12 text-muted">åŠ è½½ä¸­â€¦</div>';
      try{
        const data=await safeGet('/videos/review');
        renderVideoReview(data);
      }catch(e){
        const msg=e?.response?.status===403?'æ— æƒé™ï¼Œè¯·ä½¿ç”¨ç®¡ç†å‘˜è´¦å·é‡æ–°ç™»å½•':(e?.response?.data||'åŠ è½½å¤±è´¥');
        box.innerHTML=`<div class="col-12 text-danger">${msg}</div>`;
      }
    }
    function renderVideoReview(data){ const box=document.getElementById('video-review-list'); if(!data||!data.length){ box.innerHTML='<div class="col-12 text-muted">æš‚æ— å¾…å®¡æ ¸è§†é¢‘</div>'; return; } box.innerHTML=''; data.forEach(v=>{ const col=document.createElement('div'); col.className='col-12 col-md-6'; const uploaded=v.uploadedAt?String(v.uploadedAt).replace('T',' '):''; col.innerHTML=`<div class="card h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-1"><div class="fw-semibold">${v.title||v.filename||'è§†é¢‘'} <span class="badge bg-warning text-dark">å¾…å®¡æ ¸</span></div><span class="badge bg-light text-dark">#${v.id}</span></div><div class="text-muted small mb-1">æ•™å¸ˆ:${v.teacherId??'-'} è¯¾ç¨‹:${v.courseId??'-'} | å¤§å°:${formatSize(v.size)}</div><div class="text-muted small mb-2">ä¸Šä¼ æ—¶é—´:${uploaded||'-'}</div><div class="d-flex gap-2 flex-wrap"><button class="btn btn-sm btn-success" onclick="approveVideo(${v.id},1)">é€šè¿‡</button><button class="btn btn-sm btn-outline-danger" onclick="rejectVideo(${v.id})">ä¸é€šè¿‡</button><a class="btn btn-sm btn-outline-secondary" href="${API}/videos/serve/${v.teacherId}/${v.courseId}/${encodeURIComponent(v.filename)}" target="_blank" rel="noreferrer">é¢„è§ˆ</a></div></div></div>`; box.appendChild(col); }); }
    async function approveVideo(id, approved){ await axios.put(`${API}/videos/${id}/approve?approved=${approved}`); loadPendingVideos(); }
    async function rejectVideo(id){ const remark=prompt('è¯·å¡«å†™ä¸é€šè¿‡åŸå› ',''); await axios.put(`${API}/videos/${id}/approve?approved=-1&remark=${encodeURIComponent(remark||'ä¸é€šè¿‡')}`); loadPendingVideos(); }

    async function logout(){ try{ await axios.post(`${API}/auth/logout`);}catch(_){ } location.href='index.html'; }

    setApiFromQuery();
    loadMe();
  </script>
</body>
</html>
